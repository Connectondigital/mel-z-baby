<main class="flex-1 flex flex-col items-center py-8 px-4 sm:px-8" id="order-detail-page">
  <div class="w-full max-w-[1200px] flex flex-col gap-6">
    
    <!-- Breadcrumb -->
    <div class="flex flex-wrap gap-2 text-sm">
      <a class="text-text-secondary hover:text-primary font-medium transition-colors" href="/anasayfa/dist/index.html">Ana Sayfa</a>
      <span class="text-text-secondary font-medium">/</span>
      <a class="text-text-secondary hover:text-primary font-medium transition-colors" href="/hesabim/dist/index.html">Hesabım</a>
      <span class="text-text-secondary font-medium">/</span>
      <span class="text-text-main font-bold" id="breadcrumb-order">Sipariş Detayı</span>
    </div>

    <!-- Order Header -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 pb-2 border-b border-border-color">
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-4 flex-wrap">
          <h1 class="text-text-main text-3xl md:text-4xl font-black leading-tight tracking-tight" id="order-title">Sipariş Detayı</h1>
          <span class="flex h-8 items-center justify-center gap-x-1.5 rounded-full px-4" id="order-status">
            <span class="size-2 rounded-full" id="status-dot"></span>
            <span class="text-sm font-bold" id="status-text">Yükleniyor</span>
          </span>
        </div>
        <p class="text-text-secondary text-base font-medium flex items-center gap-2" id="order-date-display">
          <span class="material-symbols-outlined text-[18px]">calendar_today</span>
          <span id="order-date-text">--</span>
        </p>
      </div>
      <div class="flex flex-wrap gap-3">
        <button onclick="window.print()" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-border-color rounded-lg text-text-main text-sm font-bold hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
          <span class="material-symbols-outlined text-[20px]">print</span>
          Yazdır
        </button>
        <a href="/iletisim/dist/index.html" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-border-color rounded-lg text-text-main text-sm font-bold hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
          <span class="material-symbols-outlined text-[20px]">support_agent</span>
          Destek Al
        </a>
      </div>
    </div>

    <!-- Order Timeline -->
    <div class="bg-surface-light p-6 rounded-xl border border-border-color shadow-sm">
      <div class="flex items-center gap-2 mb-6">
        <span class="material-symbols-outlined text-primary">local_shipping</span>
        <h3 class="text-lg font-bold text-text-main">Sipariş Durumu</h3>
      </div>
      
      <!-- Progress Bar -->
      <div class="relative mb-8">
        <div class="flex justify-between relative z-10">
          <div class="flex flex-col items-center">
            <div class="size-10 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg">
              <span class="material-symbols-outlined text-[20px]">check</span>
            </div>
            <span class="text-xs font-bold mt-2 text-green-600">Sipariş Alındı</span>
          </div>
          <div class="flex flex-col items-center">
            <div class="size-10 rounded-full bg-yellow-500 text-white flex items-center justify-center shadow-lg" id="step-preparing">
              <span class="material-symbols-outlined text-[20px]">inventory_2</span>
            </div>
            <span class="text-xs font-bold mt-2 text-yellow-600" id="step-preparing-text">Hazırlanıyor</span>
          </div>
          <div class="flex flex-col items-center">
            <div class="size-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center" id="step-shipped">
              <span class="material-symbols-outlined text-[20px]">local_shipping</span>
            </div>
            <span class="text-xs font-bold mt-2 text-gray-400" id="step-shipped-text">Kargoda</span>
          </div>
          <div class="flex flex-col items-center">
            <div class="size-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center" id="step-delivered">
              <span class="material-symbols-outlined text-[20px]">home</span>
            </div>
            <span class="text-xs font-bold mt-2 text-gray-400" id="step-delivered-text">Teslim Edildi</span>
          </div>
        </div>
        <!-- Progress Line -->
        <div class="absolute top-5 left-[5%] right-[5%] h-1 bg-gray-200 -z-0">
          <div class="h-full bg-primary rounded-full" style="width: 33%" id="progress-bar"></div>
        </div>
      </div>

      <!-- Estimated Delivery -->
      <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg flex items-center gap-3">
        <span class="material-symbols-outlined text-blue-500 text-[28px]">schedule</span>
        <div>
          <p class="text-sm font-bold text-blue-700 dark:text-blue-300">Tahmini Teslimat</p>
          <p class="text-lg font-black text-blue-900 dark:text-blue-100" id="estimated-delivery">3-5 İş Günü</p>
        </div>
      </div>
    </div>

    <!-- Info Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Order Summary -->
      <div class="bg-surface-light p-6 rounded-xl border border-border-color shadow-sm flex flex-col gap-4">
        <div class="flex items-center gap-3 mb-2">
          <div class="size-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
            <span class="material-symbols-outlined">summarize</span>
          </div>
          <h3 class="text-lg font-bold text-text-main">Sipariş Özeti</h3>
        </div>
        <div class="flex flex-col gap-3">
          <div class="flex justify-between items-center text-sm">
            <span class="text-text-secondary">Sipariş No</span>
            <span class="text-text-main font-medium" id="summary-order-id">#---</span>
          </div>
          <div class="flex justify-between items-center text-sm">
            <span class="text-text-secondary">Sipariş Tarihi</span>
            <span class="text-text-main font-medium" id="summary-date">--</span>
          </div>
          <div class="flex justify-between items-center text-sm">
            <span class="text-text-secondary">Ödeme Yöntemi</span>
            <span class="text-text-main font-medium flex items-center gap-1">
              <span class="material-symbols-outlined text-[16px]">credit_card</span>
              Kredi Kartı
            </span>
          </div>
          <div class="h-px bg-border-color my-1"></div>
          <div class="flex justify-between items-center text-base">
            <span class="text-text-main font-bold">Toplam Tutar</span>
            <span class="text-primary font-black text-xl" id="summary-total">₺0,00</span>
          </div>
        </div>
      </div>

      <!-- Customer Info -->
      <div class="bg-surface-light p-6 rounded-xl border border-border-color shadow-sm flex flex-col gap-4">
        <div class="flex items-center gap-3 mb-2">
          <div class="size-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center">
            <span class="material-symbols-outlined">person</span>
          </div>
          <h3 class="text-lg font-bold text-text-main">Müşteri Bilgileri</h3>
        </div>
        <div class="flex flex-col gap-3 w-full" id="customer-info">
          <p class="text-text-main font-bold text-lg" id="customer-name">Müşteri</p>
          <div class="flex items-center gap-3 text-sm text-text-secondary">
            <span class="material-symbols-outlined text-[18px]">mail</span>
            <span id="customer-email">--</span>
          </div>
          <div class="flex items-center gap-3 text-sm text-text-secondary">
            <span class="material-symbols-outlined text-[18px]">call</span>
            <span id="customer-phone">--</span>
          </div>
        </div>
      </div>

      <!-- Delivery Address -->
      <div class="bg-surface-light p-6 rounded-xl border border-border-color shadow-sm flex flex-col gap-4">
        <div class="flex items-center gap-3 mb-2">
          <div class="size-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center">
            <span class="material-symbols-outlined">location_on</span>
          </div>
          <h3 class="text-lg font-bold text-text-main">Teslimat Adresi</h3>
        </div>
        <div class="flex flex-col gap-2" id="delivery-address-card">
          <p class="text-text-main text-sm leading-relaxed" id="delivery-address">
            Adres bilgisi belirtilmemiş.
          </p>
        </div>
      </div>
    </div>

    <!-- Order Items Table -->
    <div class="bg-surface-light rounded-xl border border-border-color shadow-sm overflow-hidden">
      <div class="p-6 border-b border-border-color flex justify-between items-center">
        <h3 class="text-lg font-bold text-text-main flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">shopping_bag</span>
          Sipariş Edilen Ürünler
        </h3>
        <span class="text-sm text-text-secondary bg-background-light px-3 py-1 rounded-full border border-border-color" id="item-count">0 Ürün</span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-background-light text-text-secondary text-xs uppercase tracking-wider">
              <th class="p-4 font-bold border-b border-border-color">Ürün Detayı</th>
              <th class="p-4 font-bold border-b border-border-color text-center">Birim Fiyat</th>
              <th class="p-4 font-bold border-b border-border-color text-center">Adet</th>
              <th class="p-4 font-bold border-b border-border-color text-right">Ara Toplam</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border-color" id="items-table-body">
            <tr>
              <td colspan="4" class="p-8 text-center text-gray-400">
                <span class="material-symbols-outlined mr-2">hourglass_empty</span>
                Yükleniyor...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Totals Footer -->
      <div class="bg-background-light/30 p-6 flex flex-col md:flex-row justify-end items-end md:items-start gap-8">
        <div class="w-full md:w-80 flex flex-col gap-3" id="totals-section">
          <div class="flex justify-between items-center text-sm">
            <span class="text-text-secondary">Ara Toplam</span>
            <span class="text-text-main font-medium" id="total-subtotal">₺0,00</span>
          </div>
          <div class="flex justify-between items-center text-sm">
            <span class="text-text-secondary">Kargo Ücreti</span>
            <span class="text-text-main font-medium" id="total-shipping">₺0,00</span>
          </div>
          <div class="h-px bg-border-color my-2"></div>
          <div class="flex justify-between items-center">
            <span class="text-text-main font-bold text-lg">Genel Toplam</span>
            <span class="text-primary font-black text-2xl" id="total-final">₺0,00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-4">
      <a href="/bebek-urunleri/dist/index.html" class="flex items-center gap-2 text-primary font-bold hover:underline">
        <span class="material-symbols-outlined">arrow_back</span>
        Alışverişe Devam Et
      </a>
      <div class="flex gap-3">
        <a href="/iletisim/dist/index.html" class="text-text-secondary hover:text-primary text-sm font-medium flex items-center gap-2 px-4 py-2 hover:bg-gray-50 rounded-lg transition-colors">
          <span class="material-symbols-outlined text-[18px]">help</span>
          Yardım Al
        </a>
      </div>
    </div>
  </div>
</main>

<script>
// Order Detail Page Logic
document.addEventListener('DOMContentLoaded', async function() {
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('orderId') || 'MLZ-DEMO';
  
  // Update order ID displays
  document.getElementById('order-title').textContent = 'Sipariş #' + orderId;
  document.getElementById('breadcrumb-order').textContent = 'Sipariş #' + orderId;
  document.getElementById('summary-order-id').textContent = '#' + orderId;

  // Set order date
  const now = new Date();
  const dateStr = now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  document.getElementById('order-date-text').textContent = dateStr;
  document.getElementById('summary-date').textContent = now.toLocaleDateString('tr-TR');

  // Set status (mock - always "preparing")
  const statusEl = document.getElementById('order-status');
  statusEl.className = 'flex h-8 items-center justify-center gap-x-1.5 rounded-full bg-yellow-100 px-4 text-yellow-700';
  document.getElementById('status-dot').className = 'size-2 rounded-full bg-yellow-600';
  document.getElementById('status-text').textContent = 'Hazırlanıyor';

  // Try to get order data from sessionStorage first, then localStorage
  let orderData = null;
  try {
    let stored = sessionStorage.getItem('melz_last_order');
    if (!stored) {
      stored = localStorage.getItem('melz_last_order');
    }
    if (stored) {
      orderData = JSON.parse(stored);
    }
  } catch (e) {
    console.warn('[OrderDetail] Could not parse stored order data');
  }

  // Use mock data if no stored order
  if (!orderData && typeof MelzV2 !== 'undefined') {
    const mockProducts = MelzV2.MOCK_PRODUCTS || [];
    orderData = {
      items: mockProducts.slice(0, 2).map(p => ({
        id: p.id,
        name: p.name,
        price: p.salePrice || p.price,
        qty: 1,
        size: p.sizes?.[0] || null,
        image: p.images?.[0] || null
      })),
      subtotal: 600,
      shipping: 0,
      total: 600,
      isFreeShipping: true,
      delivery: {
        name: 'Müşteri Adı',
        phone: '+90 5XX XXX XX XX',
        address: 'Adres bilgisi'
      }
    };
  }

  if (!orderData) {
    orderData = { items: [], subtotal: 0, shipping: 0, total: 0 };
  }

  // Render items table
  const tableBody = document.getElementById('items-table-body');
  const PLACEHOLDER = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect fill='%23f4f2f0' width='64' height='64'/%3E%3C/svg%3E";

  if (orderData.items?.length > 0) {
    tableBody.innerHTML = orderData.items.map(item => {
      const lineTotal = (item.price || 0) * (item.qty || 1);
      return `
        <tr class="group hover:bg-background-light/50 transition-colors">
          <td class="p-4">
            <div class="flex items-center gap-4 min-w-[240px]">
              <div class="size-16 rounded-lg border border-border-color bg-white p-1 shrink-0">
                <div class="w-full h-full rounded bg-cover bg-center" style="background-image: url('${item.image || PLACEHOLDER}');"></div>
              </div>
              <div class="flex flex-col">
                <span class="text-text-main font-bold text-sm">${escapeHtml(item.name)}</span>
                ${item.size ? `<span class="text-text-secondary text-xs mt-1">Beden: ${escapeHtml(item.size)}</span>` : ''}
              </div>
            </div>
          </td>
          <td class="p-4 text-center">
            <span class="text-text-main font-medium text-sm">${formatTRY(item.price)}</span>
          </td>
          <td class="p-4 text-center">
            <span class="inline-flex items-center justify-center bg-white border border-border-color rounded-md px-3 py-1 text-sm font-bold text-text-main">${item.qty}</span>
          </td>
          <td class="p-4 text-right">
            <span class="text-text-main font-bold text-sm">${formatTRY(lineTotal)}</span>
          </td>
        </tr>
      `;
    }).join('');

    document.getElementById('item-count').textContent = orderData.items.length + ' Ürün';
  } else {
    tableBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400">Sipariş detayı bulunamadı.</td></tr>';
  }

  // Update totals
  document.getElementById('total-subtotal').textContent = formatTRY(orderData.subtotal);
  const shippingEl = document.getElementById('total-shipping');
  if (orderData.isFreeShipping) {
    shippingEl.textContent = 'Ücretsiz';
    shippingEl.className = 'text-green-600 font-medium';
  } else {
    shippingEl.textContent = formatTRY(orderData.shipping);
  }
  document.getElementById('total-final').textContent = formatTRY(orderData.total);
  document.getElementById('summary-total').textContent = formatTRY(orderData.total);

  // Update delivery info
  if (orderData.delivery) {
    document.getElementById('customer-name').textContent = orderData.delivery.name || 'Müşteri';
    document.getElementById('customer-phone').textContent = orderData.delivery.phone || '--';
    document.getElementById('delivery-address').textContent = orderData.delivery.address || 'Adres belirtilmemiş';
  }

  function formatTRY(n) {
    if (typeof MelzV2 !== 'undefined' && MelzV2.fmtTRY) {
      return MelzV2.fmtTRY(n);
    }
    try {
      return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(Number(n || 0));
    } catch {
      return '₺' + Number(n || 0).toFixed(2);
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
});
</script>
